<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Sistema de Agendamentos Completo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
            rel="stylesheet"
    />

    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/locales/pt-br.global.min.js'></script>

    <style>
        #modal-cadastro {
          opacity: 0;
          /* Isso garante que o modal comece invisível para a animação de fade-in */
      }
      .form-input {
  transition: all 0.2s ease-in-out;
}
.form-input:focus {
  border-color: #4f46e5; /* Cor índigo */
  box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.4);
}
button {
  transition: all 0.2s ease-in-out;
}
button:active {
  transform: scale(0.97);
}
      @keyframes pulse {
50% { opacity: 0.5; }
}
.skeleton-loader {
animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
background-color: #374151; /* bg-gray-700 */
border-radius: 0.5rem; /* rounded-lg */
}

      body {
          background: radial-gradient(
                  circle at top left,
                  rgba(99, 102, 241, 0.1),
                  transparent 40%
          ),
          radial-gradient(
                  circle at bottom right,
                  rgba(236, 72, 153, 0.08),
                  transparent 40%
          ),
          radial-gradient(
                  circle at center,
                  rgba(34, 211, 238, 0.05),
                  transparent 60%
          ),
          linear-gradient(to bottom right, #111827, #000000);
          background-size: cover;
          background-attachment: fixed;
          min-height: 100vh;
      }

      .tab-button {
          transition: all 0.3s ease;
      }

      .tab-button.active {
          background-color: rgba(99, 102, 241, 0.2);
          border-color: rgba(99, 102, 241, 0.5);
      }

      .card {
          background: rgba(17, 24, 39, 0.8);
          backdrop-filter: blur(10px);
          border-radius: 1rem;
          box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.5);
      }

      .form-input, .form-select {
          background: rgba(31, 41, 55, 0.6);
          border: 1px solid rgba(55, 65, 81, 0.8);
          transition: all 0.3s;
      }

      .form-input:focus, .form-select:focus {
          outline: none;
          border-color: rgba(99, 102, 241, 0.8);
          box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
      }

      .loading {
          display: inline-block;
          width: 20px;
          height: 20px;
          border: 3px solid rgba(255, 255, 255, 0.3);
          border-radius: 50%;
          border-top-color: #fff;
          animation: spin 1s ease-in-out infinite;
      }

      @keyframes spin {
          to {
              transform: rotate(360deg);
          }
      }
      .filtro-btn {
      background-color: rgba(55, 65, 81, 0.5); /* bg-gray-700 com opacidade */
      transition: background-color 0.2s;
  }
  .filtro-btn:hover {
      background-color: rgba(75, 85, 99, 0.7); /* bg-gray-600 com opacidade */
  }
  .filtro-btn.active {
      background-color: #4f46e5; /* bg-indigo-600 */
      font-weight: bold;
  }
  :root {
--fc-border-color: rgba(55, 65, 81, 0.8);
--fc-today-bg-color: rgba(75, 85, 99, 0.3);
}
.fc .fc-button-primary {
background-color: #4f46e5; border-color: #4f46e5;
}
.fc .fc-button-primary:hover {
background-color: #4338ca; border-color: #4338ca;
}
.fc-event {
  cursor: pointer;
}



  .fc .fc-col-header {
  background-color: #111827; /* Um fundo escuro sólido */
}
.fc .fc-col-header-cell {
  padding: 8px 0; /* Um pouco mais de espaço */
  border-color: rgba(55, 65, 81, 0.8) !important;
}
.fc .fc-col-header-cell-cushion { /* O link dentro da célula do dia */
  color: #9ca3af; /* Cor cinza-claro para o texto (dom, seg, ter...) */
  text-decoration: none;
  font-weight: 600;
}


    </style>
</head>
<body class="text-gray-100 p-4 md:p-8">
<div class="container mx-auto max-w-7xl">
    <header
            class="flex flex-col md:flex-row justify-between items-center mb-8 p-4 card"
    >
        <div class="flex items-center mb-4 md:mb-0">
            <i class="fas fa-calendar-check text-3xl text-indigo-500 mr-3"></i>
            <h1 class="text-2xl font-bold">Sistema de Agendamentos</h1>
        </div>
    </header>

    <div class="flex flex-wrap gap-2 mb-6">
        <button class="tab-button active px-4 py-2 rounded-lg border border-gray-700" data-tab="dashboard">
            <i class="fas fa-chart-line mr-2"></i>Dashboard
        </button>
        <button class="tab-button px-4 py-2 rounded-lg border border-gray-700" data-tab="agendar">
            <i class="fas fa-plus-circle mr-2"></i>Agendar
        </button>
        <button class="tab-button px-4 py-2 rounded-lg border border-gray-700" data-tab="agendamentos">
            <i class="fas fa-list mr-2"></i>Agendamentos
        </button>
        <button class="tab-button px-4 py-2 rounded-lg border border-gray-700" data-tab="servicos">
            <i class="fas fa-concierge-bell mr-2"></i>Serviços
        </button>
        <button class="tab-button px-4 py-2 rounded-lg border border-gray-700" data-tab="funcionarios">
            <i class="fas fa-user-tie mr-2"></i>Funcionários
        </button>
        <button class="tab-button px-4 py-2 rounded-lg border border-gray-700" data-tab="clientes">
            <i class="fas fa-users mr-2"></i>Clientes
        </button>
    </div>

    <div class="space-y-6">
        <div id="dashboard-content" class="tab-content card p-6">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                <h2 class="text-xl font-bold mb-4 md:mb-0">Visão Geral</h2>
                <div class="flex space-x-2" id="dashboard-filtros">
                    <button data-periodo="dia" class="filtro-btn px-3 py-1 rounded-md text-sm">Hoje</button>
                    <button data-periodo="semana" class="filtro-btn px-3 py-1 rounded-md text-sm">Esta Semana</button>
                    <button data-periodo="mes" class="filtro-btn px-3 py-1 rounded-md text-sm">Este Mês</button>
                    <button data-periodo="total" class="filtro-btn px-3 py-1 rounded-md text-sm active">Total</button>
                </div>
            </div>

            <div id="dashboard-cards" class="grid grid-cols-2 md:grid-cols-5 gap-4 text-center">
            </div>

            <hr class="my-8 border-gray-700">

            <div id='calendar'></div>
        </div>

        <div class="tab-content card p-6 hidden" id="agendar-content">
            <h2 class="text-xl font-bold mb-6">Novo Agendamento</h2>
            <form id="form-agendamento">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block mb-2 text-sm font-medium">Cliente</label>
                        <select class="w-full px-3 py-2 form-select rounded-lg" id="agendamento-cliente"></select>
                    </div>
                    <div>
                        <label class="block mb-2 text-sm font-medium">Funcionário</label>
                        <select class="w-full px-3 py-2 form-select rounded-lg" id="agendamento-funcionario"></select>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block mb-2 text-sm font-medium">Serviço</label>
                        <select class="w-full px-3 py-2 form-select rounded-lg" id="agendamento-servico"></select>
                    </div>
                    <div>
                        <label class="block mb-2 text-sm font-medium">Data</label>
                        <input class="w-full px-3 py-2 form-input rounded-lg" id="agendamento-data" type="date"/>
                    </div>
                    <div>
                        <label class="block mb-2 text-sm font-medium">Horário</label>
                        <input class="w-full px-3 py-2 form-input rounded-lg" id="agendamento-horario" type="time"/>
                    </div>
                </div>
                <div class="flex justify-end mt-6">
                    <button class="px-6 py-2 bg-indigo-600 rounded-lg hover:bg-indigo-700 transition" type="submit">
                        Agendar
                    </button>
                </div>
            </form>
        </div>

        <div class="tab-content card p-6 hidden" id="agendamentos-content">
            <h2 class="text-xl font-bold mb-6">Agendamentos Realizados</h2>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                    <tr class="text-left border-b border-gray-700">
                        <th class="p-2">Cliente</th>
                        <th class="p-2">Funcionário</th>
                        <th class="p-2">Serviço</th>
                        <th class="p-2">Data</th>
                        <th class="p-2">Hora</th>
                        <th class="p-2 text-right">Ações</th>
                    </tr>
                    </thead>
                    <tbody id="agendamentos-list"></tbody>
                </table>
            </div>
        </div>

        <div class="tab-content card p-6 hidden" id="servicos-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">Gerenciar Serviços</h2>
                <button class="bg-indigo-600 hover:bg-indigo-700 px-4 py-2 rounded-lg transition" id="novo-servico-btn">
                    <i class="fas fa-plus mr-2"></i>Novo Serviço
                </button>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                    <tr class="text-left border-b border-gray-700">
                        <th class="p-2">Nome</th>
                        <th class="p-2">Duração</th>
                        <th class="p-2">Preço</th>
                        <th class="p-2 text-right">Ações</th>
                    </tr>
                    </thead>
                    <tbody id="servicos-list"></tbody>
                </table>
            </div>
        </div>

        <div class="tab-content card p-6 hidden" id="funcionarios-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">Gerenciar Funcionários</h2>
                <button class="bg-indigo-600 hover:bg-indigo-700 px-4 py-2 rounded-lg transition"
                        id="novo-funcionario-btn">
                    <i class="fas fa-plus mr-2"></i>Novo Funcionário
                </button>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                    <tr class="text-left border-b border-gray-700">
                        <th class="p-2">Nome</th>
                        <th class="p-2">Especialidade</th>
                        <th class="p-2">Telefone</th>
                        <th class="p-2">Horário de Trabalho</th>
                        <th class="p-2 text-right">Ações</th>
                    </tr>
                    </thead>
                    <tbody id="funcionarios-list"></tbody>
                </table>
            </div>
        </div>

        <div class="tab-content card p-6 hidden" id="clientes-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">Gerenciar Clientes</h2>
                <button class="bg-indigo-600 hover:bg-indigo-700 px-4 py-2 rounded-lg transition" id="novo-cliente-btn">
                    <i class="fas fa-plus mr-2"></i>Novo Cliente
                </button>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                    <tr class="text-left border-b border-gray-700">
                        <th class="p-2">Nome</th>
                        <th class="p-2">Telefone</th>
                        <th class="p-2 text-right">Ações</th>
                    </tr>
                    </thead>
                    <tbody id="clientes-list"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div id="modal-cadastro" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50 transition-opacity duration-300 ease-out">
    <div class="bg-gray-900 rounded-2xl p-6 w-full max-w-md mx-4">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold" id="modal-titulo">Novo Cadastro</h3>
            <button class="text-gray-400 hover:text-white" id="fechar-modal"><i class="fas fa-times"></i></button>
        </div>

        <form id="form-cadastro">
            <input id="cadastro-id" type="hidden"/>

            <input id="cadastro-tipo" type="hidden"/>
            <div class="hidden space-y-4" id="campos-servico">
                <div><label class="block mb-2 text-sm font-medium">Nome do Serviço</label><input
                        class="w-full px-3 py-2 form-input rounded-lg"
                        id="servico-nome"
                        type="text"/>
                </div>
                <div><label class="block mb-2 text-sm font-medium">Duração (minutos)</label><input
                        class="w-full px-3 py-2 form-input rounded-lg"
                        id="servico-duracao"
                        type="number"/>
                </div>
                <div><label class="block mb-2 text-sm font-medium">Preço (R$)</label><input
                        class="w-full px-3 py-2 form-input rounded-lg" id="servico-preco"
                        step="0.01"
                        type="number"/>
                </div>
            </div>
            <div class="hidden space-y-4" id="campos-funcionario">
                <div><label class="block mb-2 text-sm font-medium">Nome Completo</label><input
                        class="w-full px-3 py-2 form-input rounded-lg"
                        id="funcionario-nome"
                        type="text"/>
                </div>
                <div><label class="block mb-2 text-sm font-medium">Especialidade</label><input
                        class="w-full px-3 py-2 form-input rounded-lg"
                        id="funcionario-especialidade"
                        type="text"/>
                </div>
                <div><label class="block mb-2 text-sm font-medium">Telefone</label><input
                        class="w-full px-3 py-2 form-input rounded-lg"
                        id="funcionario-telefone"
                        type="tel"/>
                </div>
                <div><label class="block mb-2 text-sm font-medium">Email</label><input
                        class="w-full px-3 py-2 form-input rounded-lg"
                        id="funcionario-email"
                        type="email"/>
                </div>
                <div><label class="block mb-2 text-sm font-medium">Horário de Início</label><input
                        class="w-full px-3 py-2 form-input rounded-lg"
                        id="funcionario-horario-inicio"
                        type="time"/>
                </div>
                <div><label class="block mb-2 text-sm font-medium">Horário de Fim</label><input
                        class="w-full px-3 py-2 form-input rounded-lg"
                        id="funcionario-horario-fim"
                        type="time"/>
                </div>
                <div><label class="block mb-2 text-sm font-medium">Dias de Trabalho</label><input
                        class="w-full px-3 py-2 form-input rounded-lg"
                        id="funcionario-dias"
                        placeholder="Ex: Seg, Qua, Sex"
                        type="text"/>
                </div>
            </div>
            <div class="hidden space-y-4" id="campos-cliente">
                <div><label class="block mb-2 text-sm font-medium">Nome Completo</label><input
                        class="w-full px-3 py-2 form-input rounded-lg"
                        id="cliente-nome"
                        type="text"/>
                </div>
                <div><label class="block mb-2 text-sm font-medium">Telefone</label><input
                        class="w-full px-3 py-2 form-input rounded-lg"
                        id="cliente-telefone"
                        type="tel"/>
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button class="px-4 py-2 border border-gray-700 rounded-lg hover:bg-gray-800 transition"
                        id="cancelar-cadastro"
                        type="button">Cancelar
                </button>
                <button class="px-4 py-2 bg-indigo-600 rounded-lg hover:bg-indigo-700 transition"
                        id="salvar-cadastro-btn"
                        type="button">Salvar
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    // =================================================================================
    // ||                        INÍCIO DO SCRIPT                                     ||
    // =================================================================================

    const API_BASE_URL = "https://sistema-agendamento-fullstack-production-c736.up.railway.app/api";
    let todosAgendamentos = [];
    let calendar;


    function showToast(message, type = 'success') {
        const colors = {
            success: 'linear-gradient(to right, #00b09b, #96c93d)',
            error: 'linear-gradient(to right, #ff5f6d, #ffc371)'
        };
        Toastify({
            text: message, duration: 3000, close: true, gravity: "top", position: "right", stopOnFocus: true,
            style: { background: colors[type] || colors.success },
        }).showToast();
    }
    function inicializarCalendario() {
    const calendarEl = document.getElementById('calendar');
    if (!calendarEl) return;
    calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'timeGridWeek',
        locale: 'pt-br',
        headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,timeGridDay' },
        buttonText: { today: 'Hoje', month: 'Mês', week: 'Semana', day: 'Dia' },
        allDaySlot: false,
        slotMinTime: '08:00:00',
        slotMaxTime: '20:00:00',
        height: 'auto',
        events: (fetchInfo, successCallback, failureCallback) => {
            const eventosFormatados = todosAgendamentos.map(ag => ({
                id: ag.idAgendamento,
                title: `${ag.servico.nomeServico} (${ag.cliente.nomeCliente})`,
                start: `${ag.dataAgendamento}T${ag.horarioAgendamento}`,
                extendedProps: { funcionario: ag.funcionario.nomeFuncionario }
            }));
            successCallback(eventosFormatados);
        },
        eventClick: (info) => {
            Swal.fire({
                title: info.event.title,
                html: `<b>Profissional:</b> ${info.event.extendedProps.funcionario}<br>
                       <b>Data:</b> ${info.event.start.toLocaleDateString('pt-BR')}<br>
                       <b>Horário:</b> ${info.event.start.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}`,
                icon: 'info', background: '#1f2937', color: '#ffffff'
            });
        }
    });
    calendar.render();
}


    document.addEventListener("DOMContentLoaded", () => {
        inicializarTudo();
    });

    function inicializarTudo() {
    inicializarAbas();
    configurarModais();
    configurarFormularios();
    inicializarCalendario();
    carregarDadosIniciais();

    document.getElementById('dashboard-filtros').addEventListener('click', (e) => {
        if (e.target.classList.contains('filtro-btn')) {
            atualizarDashboard(e.target.dataset.periodo);
        }
    });
}

    function carregarDadosIniciais() {
        carregarClientes();
        carregarFuncionarios();
        carregarServicos();
        carregarAgendamentos();
    }

    function inicializarAbas() {
        document.querySelectorAll(".tab-button").forEach(button => {
            button.addEventListener("click", function () {
                document.querySelectorAll(".tab-button").forEach(btn => btn.classList.remove("active"));
                this.classList.add("active");
                document.querySelectorAll(".tab-content").forEach(content => content.classList.add("hidden"));
                const tabName = this.getAttribute("data-tab");
                document.getElementById(`${tabName}-content`).classList.remove("hidden");
                if (tabName === 'agendar') prepararFormularioAgendamento();
                if (tabName === 'dashboard') atualizarDashboard();
            });
        });
        document.querySelector('.tab-button[data-tab="dashboard"]').click();
    }

    function configurarModais() {
        document.getElementById("novo-cliente-btn").addEventListener("click", () => abrirModalCadastro("cliente"));
        document.getElementById("novo-funcionario-btn").addEventListener("click", () => abrirModalCadastro("funcionario"));
        document.getElementById("novo-servico-btn").addEventListener("click", () => abrirModalCadastro("servico"));
        document.getElementById("fechar-modal").addEventListener("click", fecharModalCadastro);
        document.getElementById("cancelar-cadastro").addEventListener("click", fecharModalCadastro);
    }

    function configurarFormularios() {
        document.getElementById("salvar-cadastro-btn").addEventListener("click", salvarFormularioCadastro);
        document.getElementById('form-agendamento').addEventListener('submit', salvarAgendamento);
    }

    // --- LÓGICA DOS MODAIS (CRIAR E EDITAR) ---
    function abrirModalCadastro(tipo) {
    const modal = document.getElementById("modal-cadastro");
    modal.classList.remove("hidden");
    setTimeout(() => {
        modal.style.opacity = '1';
    }, 10);


        document.getElementById('form-cadastro').reset();
        document.getElementById('cadastro-id').value = '';
        const titulos = { cliente: "Novo Cliente", funcionario: "Novo Funcionário", servico: "Novo Serviço" };
        document.getElementById("modal-titulo").textContent = titulos[tipo];
        document.getElementById("cadastro-tipo").value = tipo;
        ["cliente", "funcionario", "servico"].forEach(t => document.getElementById(`campos-${t}`).classList.add("hidden"));
        document.getElementById(`campos-${tipo}`).classList.remove("hidden");
        document.getElementById("modal-cadastro").classList.remove("hidden");
    }

   function fecharModalCadastro() {
    const modal = document.getElementById("modal-cadastro");


    modal.style.opacity = '0';


    setTimeout(() => {
        modal.classList.add("hidden");
        document.getElementById("form-cadastro").reset();
    }, 300);
}

    async function abrirModalParaEditar(tipo, id) {
        try {
            const response = await fetch(`${API_BASE_URL}/${tipo}s/${id}`);
            if (!response.ok) throw new Error("Falha ao buscar dados para edição.");
            const item = await response.json();
            abrirModalCadastro(tipo);
            document.getElementById('cadastro-id').value = id;
            if (tipo === 'cliente') {
                document.getElementById('modal-titulo').textContent = "Editar Cliente";
                document.getElementById('cliente-nome').value = item.nomeCliente;
                document.getElementById('cliente-telefone').value = item.telefoneCliente;
            } else if (tipo === 'funcionario') {
                document.getElementById('modal-titulo').textContent = "Editar Funcionário";
                document.getElementById('funcionario-nome').value = item.nomeFuncionario;
                document.getElementById('funcionario-especialidade').value = item.especialidade;
                document.getElementById('funcionario-telefone').value = item.telefoneFuncionario;
                document.getElementById('funcionario-email').value = item.email;
                document.getElementById('funcionario-horario-inicio').value = item.horarioTrabalhoInicio;
                document.getElementById('funcionario-horario-fim').value = item.horarioTrabalhoFim;
                document.getElementById('funcionario-dias').value = item.diasDeTrabalho;
            } else if (tipo === 'servico') {
                document.getElementById('modal-titulo').textContent = "Editar Serviço";
                document.getElementById('servico-nome').value = item.nomeServico;
                document.getElementById('servico-duracao').value = item.duracao;
                document.getElementById('servico-preco').value = item.valorServico;
            }
        } catch (error) {
            showToast(error.message, 'error');
        }
    }

    // --- RENDERIZAÇÃO
    function renderCliente(cliente) {
        const tr = document.createElement("tr");
        tr.id = `cliente-${cliente.idCliente}`;
        tr.innerHTML = `<td class="p-2">${cliente.nomeCliente}</td><td class="p-2">${cliente.telefoneCliente}</td><td class="p-2 text-right"><button onclick="abrirModalParaEditar('cliente', ${cliente.idCliente})" class="text-indigo-400 hover:text-indigo-300 mr-3"><i class="fas fa-pencil-alt"></i></button><button onclick="excluirItem('clientes', ${cliente.idCliente})" class="text-red-400 hover:text-red-300"><i class="fas fa-trash"></i></button></td>`;
        return tr;
    }
    function renderFuncionario(f) {
    const tr = document.createElement("tr");
    tr.id = `funcionario-${f.idFuncionario}`;


    const horarioInicio = f.horarioTrabalhoInicio ? f.horarioTrabalhoInicio.substring(0, 5) : 'N/D';
    const horarioFim = f.horarioTrabalhoFim ? f.horarioTrabalhoFim.substring(0, 5) : 'N/D';

    tr.innerHTML = `
        <td class="p-2">${f.nomeFuncionario}</td>
        <td class="p-2">${f.especialidade}</td>
        <td class="p-2">${f.telefoneFuncionario}</td>
        <td class="p-2">${horarioInicio} - ${horarioFim}</td> <td class="p-2 text-right">
            <button onclick="abrirModalParaEditar('funcionario', ${f.idFuncionario})" class="text-indigo-400 hover:text-indigo-300 mr-3"><i class="fas fa-pencil-alt"></i></button>
            <button onclick="excluirItem('funcionarios', ${f.idFuncionario})" class="text-red-400 hover:text-red-300"><i class="fas fa-trash"></i></button>
        </td>`;
    return tr;
}
    function renderServico(s) {
        const tr = document.createElement("tr");
        tr.id = `servico-${s.idServico}`;
        tr.innerHTML = `<td class="p-2">${s.nomeServico}</td><td class="p-2">${s.duracao} min</td><td class="p-2">R$ ${s.valorServico.toFixed(2)}</td><td class="p-2 text-right"><button onclick="abrirModalParaEditar('servico', ${s.idServico})" class="text-indigo-400 hover:text-indigo-300 mr-3"><i class="fas fa-pencil-alt"></i></button><button onclick="excluirItem('servicos', ${s.idServico})" class="text-red-400 hover:text-red-300"><i class="fas fa-trash"></i></button></td>`;
        return tr;
    }
    function renderAgendamento(ag) {
        const tr = document.createElement("tr");
        tr.id = `agendamento-${ag.idAgendamento}`;
        const data = new Date(ag.dataAgendamento);
        const dataFormatada = data.toLocaleDateString('pt-BR', { timeZone: 'UTC' });
        tr.innerHTML = `<td class="p-2">${ag.cliente.nomeCliente}</td><td class="p-2">${ag.funcionario.nomeFuncionario}</td><td class="p-2">${ag.servico.nomeServico}</td><td class="p-2">${dataFormatada}</td><td class="p-2">${ag.horarioAgendamento.substring(0, 5)}</td><td class="p-2 text-right"><button onclick="excluirItem('agendamentos', ${ag.idAgendamento})" class="text-red-400 hover:text-red-300"><i class="fas fa-trash"></i></button></td>`;
        return tr;
    }

    // --- DASHBOARD ---
    /**
 * Calcula e exibe os cards do dashboard, filtrando os ganhos
 * pelo período selecionado (dia, semana, mes, total).
 */
function atualizarDashboard(periodo = 'total') {
    // Contagem (não mudam)
    const totalClientes = document.getElementById("clientes-list").rows.length;
    const totalFuncionarios = document.getElementById("funcionarios-list").rows.length;
    const totalServicos = document.getElementById("servicos-list").rows.length;

    // Datas
    const hoje = new Date();
    hoje.setHours(0, 0, 0, 0);

    const agendamentosFiltrados = todosAgendamentos.filter(ag => {
        const dataAgendamento = new Date(ag.dataAgendamento + 'T00:00:00');
        if (periodo === 'total') return true;

        if (periodo === 'dia') {
            return dataAgendamento.toDateString() === hoje.toDateString();
        }
        if (periodo === 'semana') {
            const inicioSemana = new Date(hoje);
            inicioSemana.setDate(hoje.getDate() - hoje.getDay());
            const fimSemana = new Date(inicioSemana);
            fimSemana.setDate(inicioSemana.getDate() + 6);
            return dataAgendamento >= inicioSemana && dataAgendamento <= fimSemana;
        }
        if (periodo === 'mes') {
            return dataAgendamento.getMonth() === hoje.getMonth() &&
                   dataAgendamento.getFullYear() === hoje.getFullYear();
        }
        return false;
    });


    const ganhosFiltrados = agendamentosFiltrados.reduce((total, ag) => total + (ag.servico.valorServico || 0), 0);
    const numAgendamentosFiltrados = agendamentosFiltrados.length;


    const containerCards = document.getElementById("dashboard-cards");
    containerCards.innerHTML = `
        <div class="p-4 bg-gray-800 rounded-lg"><p class="text-3xl font-bold">${totalClientes}</p><p class="text-gray-400">Clientes</p></div>
        <div class="p-4 bg-gray-800 rounded-lg"><p class="text-3xl font-bold">${totalFuncionarios}</p><p class="text-gray-400">Funcionários</p></div>
        <div class="p-4 bg-gray-800 rounded-lg"><p class="text-3xl font-bold">${totalServicos}</p><p class="text-gray-400">Serviços</p></div>
        <div class="p-4 bg-gray-800 rounded-lg"><p class="text-3xl font-bold">${numAgendamentosFiltrados}</p><p class="text-gray-400">Agendamentos (${periodo})</p></div>
        <div class="p-4 bg-indigo-900 rounded-lg col-span-2 md:col-span-1"><p class="text-3xl font-bold">R$ ${ganhosFiltrados.toFixed(2)}</p><p class="text-indigo-300">Ganhos (${periodo})</p></div>
    `;


    document.querySelectorAll('.filtro-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.periodo === periodo) {
            btn.classList.add('active');
        }
    });
}

    // --- FUNÇÕES DE DADOS (GET, POST, PUT, DELETE) ---
    async function carregarDados(endpoint, listaId, renderFunction) {
    const lista = document.getElementById(listaId);

     let skeletonHTML = '';
    for(let i = 0; i < 3; i++) {
        skeletonHTML += `
            <tr>
                <td class="p-2"><div class="h-4 skeleton-loader"></div></td>
                <td class="p-2"><div class="h-4 skeleton-loader"></div></td>
                <td class="p-2"><div class="h-4 skeleton-loader"></div></td>
                ${(listaId === 'funcionarios-list' || listaId === 'servicos-list' || listaId === 'agendamentos-list') ? '<td class="p-2"><div class="h-4 skeleton-loader"></div></td>' : ''}
                ${(listaId === 'agendamentos-list') ? '<td class="p-2"><div class="h-4 skeleton-loader"></div></td>' : ''}
                <td class="p-2 text-right"><div class="h-4 w-12 ml-auto skeleton-loader"></div></td>
            </tr>
        `;
    }
    lista.innerHTML = skeletonHTML;
        try {
            const response = await fetch(`${API_BASE_URL}/${endpoint}`);
            if (!response.ok) throw new Error(`Erro ao buscar ${endpoint}`);
            const dados = await response.json();

             setTimeout(() => {
            lista.innerHTML = "";
            if (dados.length === 0) {
                const colunas = lista.previousElementSibling.rows[0].cells.length;
                lista.innerHTML = `<tr><td colspan="${colunas}" class="text-center py-8 text-gray-500">Nenhum registro encontrado.</td></tr>`;
            } else {
                dados.forEach(item => lista.appendChild(renderFunction(item)));
            }
            atualizarDashboard();
        }, 300);



            if (endpoint === 'agendamentos') {
                const totalGanhos = dados.reduce((total, agendamento) => total + (agendamento.servico.valorServico || 0), 0);
                window.ganhosCalculados = totalGanhos;
            }
            
            return dados;
        } catch (error) {
    lista.innerHTML = "";

    const colunas = lista.previousElementSibling.rows[0].cells.length;
    lista.innerHTML = `<tr><td colspan="${colunas}" class="text-center py-10 text-red-400 italic">Falha ao carregar dados. Verifique a conexão.</td></tr>`;
    console.error(`Falha ao carregar ${endpoint}:`, error);
}
    }
    function carregarClientes() { carregarDados("clientes", "clientes-list", renderCliente); }
    function carregarFuncionarios() { carregarDados("funcionarios", "funcionarios-list", renderFuncionario); }
    function carregarServicos() { carregarDados("servicos", "servicos-list", renderServico); }
    function carregarAgendamentos() {
    carregarDados("agendamentos", "agendamentos-list", renderAgendamento)
        .then(dados => {
            todosAgendamentos = dados || [];
            if (calendar) calendar.refetchEvents();
            atualizarDashboard('total');
        });
}



    async function salvarFormularioCadastro(event) {
        event.preventDefault();
        const id = document.getElementById("cadastro-id").value;
        const tipo = document.getElementById("cadastro-tipo").value;
        const endpoint = tipo + "s";
        const method = id ? 'PUT' : 'POST';
        const url = id ? `${API_BASE_URL}/${endpoint}/${id}` : `${API_BASE_URL}/${endpoint}`;
        let body;
        if (tipo === "cliente") { body = { nomeCliente: document.getElementById("cliente-nome").value, telefoneCliente: document.getElementById("cliente-telefone").value }; }
        else if (tipo === "funcionario") { body = { nomeFuncionario: document.getElementById("funcionario-nome").value, especialidade: document.getElementById("funcionario-especialidade").value, telefoneFuncionario: document.getElementById("funcionario-telefone").value, email: document.getElementById("funcionario-email").value, horarioTrabalhoInicio: document.getElementById("funcionario-horario-inicio").value, horarioTrabalhoFim: document.getElementById("funcionario-horario-fim").value, diasDeTrabalho: document.getElementById("funcionario-dias").value }; }
        else if (tipo === "servico") { body = { nomeServico: document.getElementById("servico-nome").value, duracao: parseInt(document.getElementById("servico-duracao").value), valorServico: parseFloat(document.getElementById("servico-preco").value) }; }
        try {
            const response = await fetch(url, { method: method, headers: { "Content-Type": "application/json" }, body: JSON.stringify(body) });
            if (!response.ok) throw new Error(await response.text());
            const itemSalvo = await response.json();
            fecharModalCadastro();
            if (method === 'POST') {
                showToast(`${tipo.charAt(0).toUpperCase() + tipo.slice(1)} salvo com sucesso!`);
                const lista = document.getElementById(tipo + "s-list"); 

                if (lista && lista.rows.length === 1 && lista.rows[0].cells.length === 1) {
                    lista.innerHTML = ""; // Limpa a mensagem de "Nenhum registro"
                }

                if (tipo === "cliente") document.getElementById("clientes-list").appendChild(renderCliente(itemSalvo));
                else if (tipo === "funcionario") document.getElementById("funcionarios-list").appendChild(renderFuncionario(itemSalvo));
                else if (tipo === "servico") document.getElementById("servicos-list").appendChild(renderServico(itemSalvo));

            } else {
                showToast(`${tipo.charAt(0).toUpperCase() + tipo.slice(1)} atualizado com sucesso!`);
                const tipoSingular = tipo;
                const idProp = `id${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`;
                const linhaExistente = document.getElementById(`${tipoSingular}-${itemSalvo[idProp] || itemSalvo.id}`);
                let novaLinha;
                if (tipo === "cliente") novaLinha = renderCliente(itemSalvo);
                else if (tipo === "funcionario") novaLinha = renderFuncionario(itemSalvo);
                else if (tipo === "servico") novaLinha = renderServico(itemSalvo);
                if (linhaExistente && novaLinha) linhaExistente.replaceWith(novaLinha);
            }
            atualizarDashboard();
        } catch (error) {
            showToast(`Falha: ${error.message}`, 'error');
        }
    }
    async function salvarAgendamento(event) {
    event.preventDefault();
    const body = { cliente: { idCliente: document.getElementById('agendamento-cliente').value }, funcionario: { idFuncionario: document.getElementById('agendamento-funcionario').value }, servico: { idServico: document.getElementById('agendamento-servico').value }, dataAgendamento: document.getElementById('agendamento-data').value, horarioAgendamento: document.getElementById('agendamento-horario').value };
    try {
        const response = await fetch(`${API_BASE_URL}/agendamentos`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(body) });
        if (!response.ok) throw new Error(await response.text());
        const agendamentoSalvo = await response.json();

        todosAgendamentos.push(agendamentoSalvo);

        document.getElementById('agendamentos-list').appendChild(renderAgendamento(agendamentoSalvo));
        if (calendar) calendar.refetchEvents();

        atualizarDashboard();
        showToast('Agendamento salvo com sucesso!');
        document.getElementById('form-agendamento').reset();
        document.querySelector('.tab-button[data-tab="agendamentos"]').click();
    } catch (error) { showToast(`Falha ao salvar agendamento: ${error.message}`, 'error'); }
}

   /**
 * Exibe um modal de confirmação bonito e, se o usuário confirmar,
 * exclui o item especificado.
 */
 async function excluirItem(tipo, id) {
    const tipoSingular = tipo.slice(0, -1);
    Swal.fire({
        title: 'Você tem certeza?',
        text: `Deseja realmente excluir este ${tipoSingular}? Esta ação não pode ser desfeita.`,
        icon: 'warning', showCancelButton: true, confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33', confirmButtonText: 'Sim, excluir!', cancelButtonText: 'Cancelar',
        background: '#1f2937', color: '#ffffff'
    }).then((result) => {
        if (result.isConfirmed) {
            fetch(`${API_BASE_URL}/${tipo}/${id}`, { method: "DELETE" })
                .then(response => {
                    if (!response.ok) throw new Error('Erro ao excluir.');

                    const elementoParaRemover = document.getElementById(`${tipoSingular}-${id}`);
                    if (elementoParaRemover) elementoParaRemover.remove();

                    if (tipo === 'agendamentos') {
                        todosAgendamentos = todosAgendamentos.filter(ag => ag.idAgendamento !== id);
                        if (calendar) calendar.refetchEvents();
                    }

                    showToast('Item excluído com sucesso!');
                    atualizarDashboard();
                }).catch(error => showToast(`Falha na exclusão: ${error.message}`, 'error'));
        }
    });
}


    // --- FUNÇÕES UTILITÁRIAS ---
    async function popularSelect(endpoint, selectId, nomeCampo, idCampo) {
        const select = document.getElementById(selectId);
        select.innerHTML = '<option value="">Carregando...</option>';
        try {
            const response = await fetch(`${API_BASE_URL}/${endpoint}`);
            const dados = await response.json();
            select.innerHTML = '<option value="">Selecione uma opção</option>';
            dados.forEach(item => {
                const option = document.createElement('option');
                option.value = item[idCampo];
                option.textContent = item[nomeCampo];
                select.appendChild(option);
            });
        } catch (error) {
            select.innerHTML = `<option value="">Erro ao carregar</option>`;
        }
    }
    function prepararFormularioAgendamento() {
        popularSelect('clientes', 'agendamento-cliente', 'nomeCliente', 'idCliente');
        popularSelect('funcionarios', 'agendamento-funcionario', 'nomeFuncionario', 'idFuncionario');
        popularSelect('servicos', 'agendamento-servico', 'nomeServico', 'idServico');
    }

    // =================================================================================
    // ||                          FIM DO SCRIPT COMPLETO                             ||
    // =================================================================================
</script>
</body>
</html>